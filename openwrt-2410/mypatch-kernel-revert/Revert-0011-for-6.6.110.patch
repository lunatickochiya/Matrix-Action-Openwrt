From d0d1521106fe52440cb9660ce69c4c4b92089b55 Mon Sep 17 00:00:00 2001
From: lunatickochiya <125438787@qq.com>
Date: Sat, 27 Dec 2025 19:51:34 +0800
Subject: [PATCH 11/11] for 6.6.110

---
 ...msh-remove-QE-bit-for-FM25S01A-flash.patch |  28 ----
 ...nand-esmt-add-support-for-F50L1G41LC.patch |  84 ----------
 ...e-proper-wed-reference-in-mt76-wed-d.patch |  79 ----------
 ...dma-mask-limitation-and-GFP_DMA32-fo.patch |  50 ------
 ...malloc-tlb_vpn-array-to-avoid-stack-.patch |  60 -------
 ...revent-a-TLB-shutdown-on-initial-uni.patch | 146 ------------------
 ...dd-support-for-FudanMicro-FM25S01BI3.patch | 117 --------------
 ...flip_threshold-to-75-of-ECC-strength.patch |   2 +-
 ...nd-Add-support-for-Etron-EM73D044VCx.patch |   8 +-
 9 files changed, 5 insertions(+), 569 deletions(-)
 delete mode 100644 target/linux/generic/backport-6.6/420-v6.19-mtd-spinand-fmsh-remove-QE-bit-for-FM25S01A-flash.patch
 delete mode 100644 target/linux/generic/backport-6.6/422-v6.19-mtd-spinand-esmt-add-support-for-F50L1G41LC.patch
 delete mode 100644 target/linux/generic/backport-6.6/752-32-v6.18-wifi-mt76-wed-use-proper-wed-reference-in-mt76-wed-d.patch
 delete mode 100644 target/linux/generic/backport-6.6/752-33-v6.18-net-mtk-wed-add-dma-mask-limitation-and-GFP_DMA32-fo.patch
 delete mode 100644 target/linux/generic/pending-6.6/360-Revert-MIPS-mm-kmalloc-tlb_vpn-array-to-avoid-stack-.patch
 delete mode 100644 target/linux/generic/pending-6.6/361-Revert-MIPS-mm-Prevent-a-TLB-shutdown-on-initial-uni.patch
 delete mode 100644 target/linux/generic/pending-6.6/403-mtd-spinand-add-support-for-FudanMicro-FM25S01BI3.patch

diff --git a/target/linux/generic/backport-6.6/420-v6.19-mtd-spinand-fmsh-remove-QE-bit-for-FM25S01A-flash.patch b/target/linux/generic/backport-6.6/420-v6.19-mtd-spinand-fmsh-remove-QE-bit-for-FM25S01A-flash.patch
deleted file mode 100644
index 7f9ec6aca4..0000000000
--- a/target/linux/generic/backport-6.6/420-v6.19-mtd-spinand-fmsh-remove-QE-bit-for-FM25S01A-flash.patch
+++ /dev/null
@@ -1,28 +0,0 @@
-From a1d3bc606bf5c3b3ea811cc2019df6285d75b00f Mon Sep 17 00:00:00 2001
-From: Mikhail Kshevetskiy <mikhail.kshevetskiy@iopsys.eu>
-Date: Mon, 3 Nov 2025 04:01:48 +0300
-Subject: [PATCH] mtd: spinand: fmsh: remove QE bit for FM25S01A flash
-
-According to datasheet (http://eng.fmsh.com/nvm/FM25S01A_ds_eng.pdf)
-there is no QE (Quad Enable) bit for FM25S01A flash, so remove it.
-
-Fixes: 5f284dc15ca86 ("mtd: spinand: add support for FudanMicro FM25S01A")
-Signed-off-by: Mikhail Kshevetskiy <mikhail.kshevetskiy@iopsys.eu>
-Tested-by: Tianling Shen <cnsztl@gmail.com>
-Signed-off-by: Miquel Raynal <miquel.raynal@bootlin.com>
-Link: Link: https://lore.kernel.org/linux-mtd/176216634975.908445.2776312239779833518.b4-ty@bootlin.com
----
- drivers/mtd/nand/spi/fmsh.c | 2 +-
- 1 file changed, 1 insertion(+), 1 deletion(-)
-
---- a/drivers/mtd/nand/spi/fmsh.c
-+++ b/drivers/mtd/nand/spi/fmsh.c
-@@ -58,7 +58,7 @@ static const struct spinand_info fmsh_sp
- 		     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,
- 					      &write_cache_variants,
- 					      &update_cache_variants),
--		     SPINAND_HAS_QE_BIT,
-+		     0,
- 		     SPINAND_ECCINFO(&fm25s01a_ooblayout, NULL)),
- };
- 
diff --git a/target/linux/generic/backport-6.6/422-v6.19-mtd-spinand-esmt-add-support-for-F50L1G41LC.patch b/target/linux/generic/backport-6.6/422-v6.19-mtd-spinand-esmt-add-support-for-F50L1G41LC.patch
deleted file mode 100644
index f260d2ba8e..0000000000
--- a/target/linux/generic/backport-6.6/422-v6.19-mtd-spinand-esmt-add-support-for-F50L1G41LC.patch
+++ /dev/null
@@ -1,84 +0,0 @@
-From b98994cb9bc24f5c7575c86650f96c384576fdfa Mon Sep 17 00:00:00 2001
-From: Daniel Golle <daniel@makrotopia.org>
-Date: Mon, 17 Nov 2025 02:54:19 +0000
-Subject: [PATCH] mtd: spinand: esmt: add support for F50L1G41LC
-
-This adds support for ESMT F50L1G41LC, which appears to be an updated
-version of the already supported F50L1G41LB.
-Add esmt_8c SPI_NAND manufacturer to account for the newly used vendor
-ID with support for the ESMT F50L1G41LC chip.
-
-Link: https://github.com/openwrt/openwrt/pull/15214#issuecomment-3514824435
-Signed-off-by: Daniel Golle <daniel@makrotopia.org>
-Signed-off-by: Miquel Raynal <miquel.raynal@bootlin.com>
----
- drivers/mtd/nand/spi/core.c |  1 +
- drivers/mtd/nand/spi/esmt.c | 24 ++++++++++++++++++++++++
- include/linux/mtd/spinand.h |  1 +
- 3 files changed, 26 insertions(+)
-
---- a/drivers/mtd/nand/spi/core.c
-+++ b/drivers/mtd/nand/spi/core.c
-@@ -942,6 +942,7 @@ static const struct nand_ops spinand_ops
- static const struct spinand_manufacturer *spinand_manufacturers[] = {
- 	&alliancememory_spinand_manufacturer,
- 	&ato_spinand_manufacturer,
-+	&esmt_8c_spinand_manufacturer,
- 	&esmt_c8_spinand_manufacturer,
- 	&fmsh_spinand_manufacturer,
- 	&foresee_spinand_manufacturer,
---- a/drivers/mtd/nand/spi/esmt.c
-+++ b/drivers/mtd/nand/spi/esmt.c
-@@ -11,6 +11,7 @@
- 
- /* ESMT uses GigaDevice 0xc8 JECDEC ID on some SPI NANDs */
- #define SPINAND_MFR_ESMT_C8			0xc8
-+#define SPINAND_MFR_ESMT_8C			0x8c
- 
- static SPINAND_OP_VARIANTS(read_cache_variants,
- 			   SPINAND_PAGE_READ_FROM_CACHE_X4_OP(0, 1, NULL, 0),
-@@ -102,6 +103,19 @@ static const struct mtd_ooblayout_ops f5
- 	.free = f50l1g41lb_ooblayout_free,
- };
- 
-+
-+static const struct spinand_info esmt_8c_spinand_table[] = {
-+	SPINAND_INFO("F50L1G41LC",
-+		     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_ADDR, 0x2C),
-+		     NAND_MEMORG(1, 2048, 64, 64, 1024, 20, 1, 1, 1),
-+		     NAND_ECCREQ(1, 512),
-+		     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,
-+					      &write_cache_variants,
-+					      &update_cache_variants),
-+		     0,
-+		     SPINAND_ECCINFO(&f50l1g41lb_ooblayout, NULL)),
-+};
-+
- static const struct spinand_info esmt_c8_spinand_table[] = {
- 	SPINAND_INFO("F50L1G41LB",
- 		     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_ADDR, 0x01, 0x7f,
-@@ -138,6 +152,14 @@ static const struct spinand_info esmt_c8
- static const struct spinand_manufacturer_ops esmt_spinand_manuf_ops = {
- };
- 
-+const struct spinand_manufacturer esmt_8c_spinand_manufacturer = {
-+	.id = SPINAND_MFR_ESMT_8C,
-+	.name = "ESMT",
-+	.chips = esmt_8c_spinand_table,
-+	.nchips = ARRAY_SIZE(esmt_8c_spinand_table),
-+	.ops = &esmt_spinand_manuf_ops,
-+};
-+
- const struct spinand_manufacturer esmt_c8_spinand_manufacturer = {
- 	.id = SPINAND_MFR_ESMT_C8,
- 	.name = "ESMT",
---- a/include/linux/mtd/spinand.h
-+++ b/include/linux/mtd/spinand.h
-@@ -262,6 +262,7 @@ struct spinand_manufacturer {
- /* SPI NAND manufacturers */
- extern const struct spinand_manufacturer alliancememory_spinand_manufacturer;
- extern const struct spinand_manufacturer ato_spinand_manufacturer;
-+extern const struct spinand_manufacturer esmt_8c_spinand_manufacturer;
- extern const struct spinand_manufacturer esmt_c8_spinand_manufacturer;
- extern const struct spinand_manufacturer fmsh_spinand_manufacturer;
- extern const struct spinand_manufacturer foresee_spinand_manufacturer;
diff --git a/target/linux/generic/backport-6.6/752-32-v6.18-wifi-mt76-wed-use-proper-wed-reference-in-mt76-wed-d.patch b/target/linux/generic/backport-6.6/752-32-v6.18-wifi-mt76-wed-use-proper-wed-reference-in-mt76-wed-d.patch
deleted file mode 100644
index 883de549cd..0000000000
--- a/target/linux/generic/backport-6.6/752-32-v6.18-wifi-mt76-wed-use-proper-wed-reference-in-mt76-wed-d.patch
+++ /dev/null
@@ -1,79 +0,0 @@
-From: Lorenzo Bianconi <lorenzo@kernel.org>
-Date: Wed, 8 Oct 2025 12:41:48 +0200
-Subject: [PATCH] wifi: mt76: wed: use proper wed reference in mt76 wed driver
- callabacks
-
-MT7996 driver can use both wed and wed_hif2 devices to offload traffic
-from/to the wireless NIC. In the current codebase we assume to always
-use the primary wed device in wed callbacks resulting in the following
-crash if the hw runs wed_hif2 (e.g. 6GHz link).
-
-[  297.455876] Unable to handle kernel read from unreadable memory at virtual address 000000000000080a
-[  297.464928] Mem abort info:
-[  297.467722]   ESR = 0x0000000096000005
-[  297.471461]   EC = 0x25: DABT (current EL), IL = 32 bits
-[  297.476766]   SET = 0, FnV = 0
-[  297.479809]   EA = 0, S1PTW = 0
-[  297.482940]   FSC = 0x05: level 1 translation fault
-[  297.487809] Data abort info:
-[  297.490679]   ISV = 0, ISS = 0x00000005, ISS2 = 0x00000000
-[  297.496156]   CM = 0, WnR = 0, TnD = 0, TagAccess = 0
-[  297.501196]   GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
-[  297.506500] user pgtable: 4k pages, 39-bit VAs, pgdp=0000000107480000
-[  297.512927] [000000000000080a] pgd=08000001097fb003, p4d=08000001097fb003, pud=08000001097fb003, pmd=0000000000000000
-[  297.523532] Internal error: Oops: 0000000096000005 [#1] SMP
-[  297.715393] CPU: 2 UID: 0 PID: 45 Comm: kworker/u16:2 Tainted: G           O       6.12.50 #0
-[  297.723908] Tainted: [O]=OOT_MODULE
-[  297.727384] Hardware name: Banana Pi BPI-R4 (2x SFP+) (DT)
-[  297.732857] Workqueue: nf_ft_offload_del nf_flow_rule_route_ipv6 [nf_flow_table]
-[  297.740254] pstate: 60400005 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
-[  297.747205] pc : mt76_wed_offload_disable+0x64/0xa0 [mt76]
-[  297.752688] lr : mtk_wed_flow_remove+0x58/0x80
-[  297.757126] sp : ffffffc080fe3ae0
-[  297.760430] x29: ffffffc080fe3ae0 x28: ffffffc080fe3be0 x27: 00000000deadbef7
-[  297.767557] x26: ffffff80c5ebca00 x25: 0000000000000001 x24: ffffff80c85f4c00
-[  297.774683] x23: ffffff80c1875b78 x22: ffffffc080d42cd0 x21: ffffffc080660018
-[  297.781809] x20: ffffff80c6a076d0 x19: ffffff80c6a043c8 x18: 0000000000000000
-[  297.788935] x17: 0000000000000000 x16: 0000000000000001 x15: 0000000000000000
-[  297.796060] x14: 0000000000000019 x13: ffffff80c0ad8ec0 x12: 00000000fa83b2da
-[  297.803185] x11: ffffff80c02700c0 x10: ffffff80c0ad8ec0 x9 : ffffff81fef96200
-[  297.810311] x8 : ffffff80c02700c0 x7 : ffffff80c02700d0 x6 : 0000000000000002
-[  297.817435] x5 : 0000000000000400 x4 : 0000000000000000 x3 : 0000000000000000
-[  297.824561] x2 : 0000000000000001 x1 : 0000000000000800 x0 : ffffff80c6a063c8
-[  297.831686] Call trace:
-[  297.834123]  mt76_wed_offload_disable+0x64/0xa0 [mt76]
-[  297.839254]  mtk_wed_flow_remove+0x58/0x80
-[  297.843342]  mtk_flow_offload_cmd+0x434/0x574
-[  297.847689]  mtk_wed_setup_tc_block_cb+0x30/0x40
-[  297.852295]  nf_flow_offload_ipv6_hook+0x7f4/0x964 [nf_flow_table]
-[  297.858466]  nf_flow_rule_route_ipv6+0x438/0x4a4 [nf_flow_table]
-[  297.864463]  process_one_work+0x174/0x300
-[  297.868465]  worker_thread+0x278/0x430
-[  297.872204]  kthread+0xd8/0xdc
-[  297.875251]  ret_from_fork+0x10/0x20
-[  297.878820] Code: 928b5ae0 8b000273 91400a60 f943fa61 (79401421)
-[  297.884901] ---[ end trace 0000000000000000 ]---
-
-Fix the issue detecting the proper wed reference to use running wed
-callabacks.
-
--- Partial backport for data structure change only (rest is in the mt76 package)
-
-Fixes: 83eafc9251d6 ("wifi: mt76: mt7996: add wed tx support")
-Tested-by: Daniel Pawlik <pawlik.dan@gmail.com>
-Tested-by: Matteo Croce <teknoraver@meta.com>
-Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
-Link: https://patch.msgid.link/20251008-wed-fixes-v1-1-8f7678583385@kernel.org
-Signed-off-by: Felix Fietkau <nbd@nbd.name>
----
-
---- a/include/linux/soc/mediatek/mtk_wed.h
-+++ b/include/linux/soc/mediatek/mtk_wed.h
-@@ -154,6 +154,7 @@ struct mtk_wed_device {
- 		bool wcid_512;
- 		bool hw_rro;
- 		bool msi;
-+		bool hif2;
- 
- 		u16 token_start;
- 		unsigned int nbuf;
diff --git a/target/linux/generic/backport-6.6/752-33-v6.18-net-mtk-wed-add-dma-mask-limitation-and-GFP_DMA32-fo.patch b/target/linux/generic/backport-6.6/752-33-v6.18-net-mtk-wed-add-dma-mask-limitation-and-GFP_DMA32-fo.patch
deleted file mode 100644
index c1bb1b972b..0000000000
--- a/target/linux/generic/backport-6.6/752-33-v6.18-net-mtk-wed-add-dma-mask-limitation-and-GFP_DMA32-fo.patch
+++ /dev/null
@@ -1,50 +0,0 @@
-From: Rex Lu <rex.lu@mediatek.com>
-Date: Thu, 9 Oct 2025 08:29:34 +0200
-Subject: [PATCH] net: mtk: wed: add dma mask limitation and GFP_DMA32 for
- device with more than 4GB DRAM
-
-Limit tx/rx buffer address to 32-bit address space for board with more
-than 4GB DRAM.
-
-Fixes: 804775dfc2885 ("net: ethernet: mtk_eth_soc: add support for Wireless Ethernet Dispatch (WED)")
-Fixes: 6757d345dd7db ("net: ethernet: mtk_wed: introduce hw_rro support for MT7988")
-Tested-by: Daniel Pawlik <pawlik.dan@gmail.com>
-Tested-by: Matteo Croce <teknoraver@meta.com>
-Signed-off-by: Rex Lu <rex.lu@mediatek.com>
-Co-developed-by: Lorenzo Bianconi <lorenzo@kernel.org>
-Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
-Reviewed-by: Simon Horman <horms@kernel.org>
-Signed-off-by: David S. Miller <davem@davemloft.net>
----
-
---- a/drivers/net/ethernet/mediatek/mtk_wed.c
-+++ b/drivers/net/ethernet/mediatek/mtk_wed.c
-@@ -677,7 +677,7 @@ mtk_wed_tx_buffer_alloc(struct mtk_wed_d
- 		void *buf;
- 		int s;
- 
--		page = __dev_alloc_page(GFP_KERNEL);
-+		page = __dev_alloc_page(GFP_KERNEL | GFP_DMA32);
- 		if (!page)
- 			return -ENOMEM;
- 
-@@ -800,7 +800,7 @@ mtk_wed_hwrro_buffer_alloc(struct mtk_we
- 		struct page *page;
- 		int s;
- 
--		page = __dev_alloc_page(GFP_KERNEL);
-+		page = __dev_alloc_page(GFP_KERNEL | GFP_DMA32);
- 		if (!page)
- 			return -ENOMEM;
- 
-@@ -2438,6 +2438,10 @@ mtk_wed_attach(struct mtk_wed_device *de
- 	dev->version = hw->version;
- 	dev->hw->pcie_base = mtk_wed_get_pcie_base(dev);
- 
-+	ret = dma_set_mask_and_coherent(hw->dev, DMA_BIT_MASK(32));
-+	if (ret)
-+		goto out;
-+
- 	if (hw->eth->dma_dev == hw->eth->dev &&
- 	    of_dma_is_coherent(hw->eth->dev->of_node))
- 		mtk_eth_set_dma_device(hw->eth, hw->dev);
diff --git a/target/linux/generic/pending-6.6/360-Revert-MIPS-mm-kmalloc-tlb_vpn-array-to-avoid-stack-.patch b/target/linux/generic/pending-6.6/360-Revert-MIPS-mm-kmalloc-tlb_vpn-array-to-avoid-stack-.patch
deleted file mode 100644
index 1b53919a0c..0000000000
--- a/target/linux/generic/pending-6.6/360-Revert-MIPS-mm-kmalloc-tlb_vpn-array-to-avoid-stack-.patch
+++ /dev/null
@@ -1,60 +0,0 @@
-From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
-From: Hauke Mehrtens <hauke@hauke-m.de>
-Date: Mon, 15 Dec 2025 01:45:07 +0100
-Subject: Revert "MIPS: mm: kmalloc tlb_vpn array to avoid stack overflow"
-
-This reverts commit 231ac951fabae2aaed8b2c00b4a097107be49c8c.
----
- arch/mips/mm/tlb-r4k.c | 18 ++----------------
- 1 file changed, 2 insertions(+), 16 deletions(-)
-
---- a/arch/mips/mm/tlb-r4k.c
-+++ b/arch/mips/mm/tlb-r4k.c
-@@ -12,7 +12,6 @@
- #include <linux/init.h>
- #include <linux/sched.h>
- #include <linux/smp.h>
--#include <linux/memblock.h>
- #include <linux/mm.h>
- #include <linux/hugetlb.h>
- #include <linux/export.h>
-@@ -521,26 +520,17 @@ static int r4k_vpn_cmp(const void *a, co
-  * Initialise all TLB entries with unique values that do not clash with
-  * what we have been handed over and what we'll be using ourselves.
-  */
--static void __ref r4k_tlb_uniquify(void)
-+static void r4k_tlb_uniquify(void)
- {
-+	unsigned long tlb_vpns[1 << MIPS_CONF1_TLBS_SIZE];
- 	int tlbsize = current_cpu_data.tlbsize;
--	bool use_slab = slab_is_available();
- 	int start = num_wired_entries();
--	phys_addr_t tlb_vpn_size;
--	unsigned long *tlb_vpns;
- 	unsigned long vpn_mask;
- 	int cnt, ent, idx, i;
- 
- 	vpn_mask = GENMASK(cpu_vmbits - 1, 13);
- 	vpn_mask |= IS_ENABLED(CONFIG_64BIT) ? 3ULL << 62 : 1 << 31;
- 
--	tlb_vpn_size = tlbsize * sizeof(*tlb_vpns);
--	tlb_vpns = (use_slab ?
--		    kmalloc(tlb_vpn_size, GFP_KERNEL) :
--		    memblock_alloc_raw(tlb_vpn_size, sizeof(*tlb_vpns)));
--	if (WARN_ON(!tlb_vpns))
--		return; /* Pray local_flush_tlb_all() is good enough. */
--
- 	htw_stop();
- 
- 	for (i = start, cnt = 0; i < tlbsize; i++, cnt++) {
-@@ -593,10 +583,6 @@ static void __ref r4k_tlb_uniquify(void)
- 	tlbw_use_hazard();
- 	htw_start();
- 	flush_micro_tlb();
--	if (use_slab)
--		kfree(tlb_vpns);
--	else
--		memblock_free(tlb_vpns, tlb_vpn_size);
- }
- 
- /*
diff --git a/target/linux/generic/pending-6.6/361-Revert-MIPS-mm-Prevent-a-TLB-shutdown-on-initial-uni.patch b/target/linux/generic/pending-6.6/361-Revert-MIPS-mm-Prevent-a-TLB-shutdown-on-initial-uni.patch
deleted file mode 100644
index 17d0b50ad8..0000000000
--- a/target/linux/generic/pending-6.6/361-Revert-MIPS-mm-Prevent-a-TLB-shutdown-on-initial-uni.patch
+++ /dev/null
@@ -1,146 +0,0 @@
-From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
-From: Hauke Mehrtens <hauke@hauke-m.de>
-Date: Mon, 15 Dec 2025 01:45:20 +0100
-Subject: Revert "MIPS: mm: Prevent a TLB shutdown on initial uniquification"
-
-This reverts commit 135713cd0751bf296e515f5fdec234320f73bbd8.
----
- arch/mips/mm/tlb-r4k.c | 100 +++++++++++++++--------------------------
- 1 file changed, 37 insertions(+), 63 deletions(-)
-
---- a/arch/mips/mm/tlb-r4k.c
-+++ b/arch/mips/mm/tlb-r4k.c
-@@ -15,7 +15,6 @@
- #include <linux/mm.h>
- #include <linux/hugetlb.h>
- #include <linux/export.h>
--#include <linux/sort.h>
- 
- #include <asm/cpu.h>
- #include <asm/cpu-type.h>
-@@ -507,79 +506,55 @@ static int __init set_ntlb(char *str)
- 
- __setup("ntlb=", set_ntlb);
- 
--
--/* Comparison function for EntryHi VPN fields.  */
--static int r4k_vpn_cmp(const void *a, const void *b)
--{
--	long v = *(unsigned long *)a - *(unsigned long *)b;
--	int s = sizeof(long) > sizeof(int) ? sizeof(long) * 8 - 1: 0;
--	return s ? (v != 0) | v >> s : v;
--}
--
--/*
-- * Initialise all TLB entries with unique values that do not clash with
-- * what we have been handed over and what we'll be using ourselves.
-- */
-+/* Initialise all TLB entries with unique values */
- static void r4k_tlb_uniquify(void)
- {
--	unsigned long tlb_vpns[1 << MIPS_CONF1_TLBS_SIZE];
--	int tlbsize = current_cpu_data.tlbsize;
--	int start = num_wired_entries();
--	unsigned long vpn_mask;
--	int cnt, ent, idx, i;
--
--	vpn_mask = GENMASK(cpu_vmbits - 1, 13);
--	vpn_mask |= IS_ENABLED(CONFIG_64BIT) ? 3ULL << 62 : 1 << 31;
-+	int entry = num_wired_entries();
- 
- 	htw_stop();
-+	write_c0_entrylo0(0);
-+	write_c0_entrylo1(0);
- 
--	for (i = start, cnt = 0; i < tlbsize; i++, cnt++) {
--		unsigned long vpn;
-+	while (entry < current_cpu_data.tlbsize) {
-+		unsigned long asid_mask = cpu_asid_mask(&current_cpu_data);
-+		unsigned long asid = 0;
-+		int idx;
- 
--		write_c0_index(i);
--		mtc0_tlbr_hazard();
--		tlb_read();
--		tlb_read_hazard();
--		vpn = read_c0_entryhi();
--		vpn &= vpn_mask & PAGE_MASK;
--		tlb_vpns[cnt] = vpn;
-+		/* Skip wired MMID to make ginvt_mmid work */
-+		if (cpu_has_mmid)
-+			asid = MMID_KERNEL_WIRED + 1;
- 
--		/* Prevent any large pages from overlapping regular ones.  */
--		write_c0_pagemask(read_c0_pagemask() & PM_DEFAULT_MASK);
-+		/* Check for match before using UNIQUE_ENTRYHI */
-+		do {
-+			if (cpu_has_mmid) {
-+				write_c0_memorymapid(asid);
-+				write_c0_entryhi(UNIQUE_ENTRYHI(entry));
-+			} else {
-+				write_c0_entryhi(UNIQUE_ENTRYHI(entry) | asid);
-+			}
-+			mtc0_tlbw_hazard();
-+			tlb_probe();
-+			tlb_probe_hazard();
-+			idx = read_c0_index();
-+			/* No match or match is on current entry */
-+			if (idx < 0 || idx == entry)
-+				break;
-+			/*
-+			 * If we hit a match, we need to try again with
-+			 * a different ASID.
-+			 */
-+			asid++;
-+		} while (asid < asid_mask);
-+
-+		if (idx >= 0 && idx != entry)
-+			panic("Unable to uniquify TLB entry %d", idx);
-+
-+		write_c0_index(entry);
- 		mtc0_tlbw_hazard();
- 		tlb_write_indexed();
--		tlbw_use_hazard();
-+		entry++;
- 	}
- 
--	sort(tlb_vpns, cnt, sizeof(tlb_vpns[0]), r4k_vpn_cmp, NULL);
--
--	write_c0_pagemask(PM_DEFAULT_MASK);
--	write_c0_entrylo0(0);
--	write_c0_entrylo1(0);
--
--	idx = 0;
--	ent = tlbsize;
--	for (i = start; i < tlbsize; i++)
--		while (1) {
--			unsigned long entryhi, vpn;
--
--			entryhi = UNIQUE_ENTRYHI(ent);
--			vpn = entryhi & vpn_mask & PAGE_MASK;
--
--			if (idx >= cnt || vpn < tlb_vpns[idx]) {
--				write_c0_entryhi(entryhi);
--				write_c0_index(i);
--				mtc0_tlbw_hazard();
--				tlb_write_indexed();
--				ent++;
--				break;
--			} else if (vpn == tlb_vpns[idx]) {
--				ent++;
--			} else {
--				idx++;
--			}
--		}
--
- 	tlbw_use_hazard();
- 	htw_start();
- 	flush_micro_tlb();
-@@ -625,7 +600,6 @@ static void r4k_tlb_configure(void)
- 
- 	/* From this point on the ARC firmware is dead.	 */
- 	r4k_tlb_uniquify();
--	local_flush_tlb_all();
- 
- 	/* Did I tell you that ARC SUCKS?  */
- }
diff --git a/target/linux/generic/pending-6.6/403-mtd-spinand-add-support-for-FudanMicro-FM25S01BI3.patch b/target/linux/generic/pending-6.6/403-mtd-spinand-add-support-for-FudanMicro-FM25S01BI3.patch
deleted file mode 100644
index f35344233f..0000000000
--- a/target/linux/generic/pending-6.6/403-mtd-spinand-add-support-for-FudanMicro-FM25S01BI3.patch
+++ /dev/null
@@ -1,117 +0,0 @@
-To: Miquel Raynal <miquel.raynal@bootlin.com>,
- Richard Weinberger <richard@nod.at>, Vignesh Raghavendra <vigneshr@ti.com>,
- Tudor Ambarus <tudor.ambarus@linaro.org>, Mark Brown <broonie@kernel.org>
-Cc: linux-kernel@vger.kernel.org, linux-mtd@lists.infradead.org
-From: Mikhail Zhilkin <csharper2005@gmail.com>
-Subject: [PATCH] mtd: spinand: add support for FudanMicro FM25S01BI3
-
-Add support for FudanMicro FM25S01BI3 SPI NAND.
-
-Link: https://www.fmsh.com/nvm/FM25S01BI3_ds_eng.pdf
-
-Signed-off-by: Mikhail Zhilkin <csharper2005@gmail.com>
-Link: https://lore.kernel.org/linux-mtd/130e0f3f-93e4-47cf-82f0-93ba58a3a670@gmail.com
----
- drivers/mtd/nand/spi/fmsh.c | 72 +++++++++++++++++++++++++++++++++++++
- 1 file changed, 72 insertions(+)
-
---- a/drivers/mtd/nand/spi/fmsh.c
-+++ b/drivers/mtd/nand/spi/fmsh.c
-@@ -9,6 +9,13 @@
- #include <linux/kernel.h>
- #include <linux/mtd/spinand.h>
- 
-+#define FM25S01BI3_STATUS_ECC_MASK		(7 << 4)
-+	#define FM25S01BI3_STATUS_ECC_NO_BITFLIPS	(0 << 4)
-+	#define FM25S01BI3_STATUS_ECC_1_3_BITFLIPS	(1 << 4)
-+	#define FM25S01BI3_STATUS_ECC_UNCOR_ERROR	(2 << 4)
-+	#define FM25S01BI3_STATUS_ECC_4_6_BITFLIPS	(3 << 4)
-+	#define FM25S01BI3_STATUS_ECC_7_8_BITFLIPS	(5 << 4)
-+
- #define SPINAND_MFR_FMSH		0xA1
- 
- static SPINAND_OP_VARIANTS(read_cache_variants,
-@@ -45,11 +52,66 @@ static int fm25s01a_ooblayout_free(struc
- 	return 0;
- }
- 
-+static int fm25s01bi3_ecc_get_status(struct spinand_device *spinand,
-+				     u8 status)
-+{
-+	switch (status & FM25S01BI3_STATUS_ECC_MASK) {
-+	case FM25S01BI3_STATUS_ECC_NO_BITFLIPS:
-+		return 0;
-+
-+	case FM25S01BI3_STATUS_ECC_UNCOR_ERROR:
-+		return -EBADMSG;
-+
-+	case FM25S01BI3_STATUS_ECC_1_3_BITFLIPS:
-+		return 3;
-+
-+	case FM25S01BI3_STATUS_ECC_4_6_BITFLIPS:
-+		return 6;
-+
-+	case FM25S01BI3_STATUS_ECC_7_8_BITFLIPS:
-+		return 8;
-+
-+	default:
-+		break;
-+	}
-+
-+	return -EINVAL;
-+}
-+
-+static int fm25s01bi3_ooblayout_ecc(struct mtd_info *mtd, int section,
-+				    struct mtd_oob_region *region)
-+{
-+	if (section)
-+		return -ERANGE;
-+
-+	region->offset = 64;
-+	region->length = 64;
-+
-+	return 0;
-+}
-+
-+static int fm25s01bi3_ooblayout_free(struct mtd_info *mtd, int section,
-+				     struct mtd_oob_region *region)
-+{
-+	if (section > 3)
-+		return -ERANGE;
-+
-+	region->offset = (16 * section) + 4;
-+	region->length = 12;
-+
-+	return 0;
-+}
-+
- static const struct mtd_ooblayout_ops fm25s01a_ooblayout = {
- 	.ecc = fm25s01a_ooblayout_ecc,
- 	.free = fm25s01a_ooblayout_free,
- };
- 
-+static const struct mtd_ooblayout_ops fm25s01bi3_ooblayout = {
-+	.ecc = fm25s01bi3_ooblayout_ecc,
-+	.free = fm25s01bi3_ooblayout_free,
-+};
-+
- static const struct spinand_info fmsh_spinand_table[] = {
- 	SPINAND_INFO("FM25S01A",
- 		     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xE4),
-@@ -60,6 +122,16 @@ static const struct spinand_info fmsh_sp
- 					      &update_cache_variants),
- 		     0,
- 		     SPINAND_ECCINFO(&fm25s01a_ooblayout, NULL)),
-+	SPINAND_INFO("FM25S01BI3",
-+		     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xd4),
-+		     NAND_MEMORG(1, 2048, 128, 64, 1024, 20, 1, 1, 1),
-+		     NAND_ECCREQ(8, 512),
-+		     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,
-+					      &write_cache_variants,
-+					      &update_cache_variants),
-+		     SPINAND_HAS_QE_BIT,
-+		     SPINAND_ECCINFO(&fm25s01bi3_ooblayout,
-+				      fm25s01bi3_ecc_get_status)),
- };
- 
- static const struct spinand_manufacturer_ops fmsh_spinand_manuf_ops = {
diff --git a/target/linux/generic/pending-6.6/410-mtd-spinand-set-bitflip_threshold-to-75-of-ECC-strength.patch b/target/linux/generic/pending-6.6/410-mtd-spinand-set-bitflip_threshold-to-75-of-ECC-strength.patch
index 814b50e19c..7f60c21a3a 100644
--- a/target/linux/generic/pending-6.6/410-mtd-spinand-set-bitflip_threshold-to-75-of-ECC-strength.patch
+++ b/target/linux/generic/pending-6.6/410-mtd-spinand-set-bitflip_threshold-to-75-of-ECC-strength.patch
@@ -53,7 +53,7 @@ Signed-off-by: Daniel Golle <daniel@makrotopia.org>
 
 --- a/drivers/mtd/nand/spi/core.c
 +++ b/drivers/mtd/nand/spi/core.c
-@@ -1292,6 +1292,7 @@ static int spinand_init(struct spinand_d
+@@ -1291,6 +1291,7 @@ static int spinand_init(struct spinand_d
  	/* Propagate ECC information to mtd_info */
  	mtd->ecc_strength = nanddev_get_ecc_conf(nand)->strength;
  	mtd->ecc_step_size = nanddev_get_ecc_conf(nand)->step_size;
diff --git a/target/linux/generic/pending-6.6/487-mtd-spinand-Add-support-for-Etron-EM73D044VCx.patch b/target/linux/generic/pending-6.6/487-mtd-spinand-Add-support-for-Etron-EM73D044VCx.patch
index 7d7899ee59..65efad224d 100644
--- a/target/linux/generic/pending-6.6/487-mtd-spinand-Add-support-for-Etron-EM73D044VCx.patch
+++ b/target/linux/generic/pending-6.6/487-mtd-spinand-Add-support-for-Etron-EM73D044VCx.patch
@@ -49,9 +49,9 @@ Submitted-by: Daniel Danzberger <daniel@dd-wrt.com>
  obj-$(CONFIG_MTD_SPI_NAND) += spinand.o
 --- a/drivers/mtd/nand/spi/core.c
 +++ b/drivers/mtd/nand/spi/core.c
-@@ -944,6 +944,7 @@ static const struct spinand_manufacturer
+@@ -943,6 +943,7 @@ static const struct spinand_manufacturer
+ 	&alliancememory_spinand_manufacturer,
  	&ato_spinand_manufacturer,
- 	&esmt_8c_spinand_manufacturer,
  	&esmt_c8_spinand_manufacturer,
 +	&etron_spinand_manufacturer,
  	&fmsh_spinand_manufacturer,
@@ -160,9 +160,9 @@ Submitted-by: Daniel Danzberger <daniel@dd-wrt.com>
 +};
 --- a/include/linux/mtd/spinand.h
 +++ b/include/linux/mtd/spinand.h
-@@ -264,6 +264,7 @@ extern const struct spinand_manufacturer
+@@ -263,6 +263,7 @@ struct spinand_manufacturer {
+ extern const struct spinand_manufacturer alliancememory_spinand_manufacturer;
  extern const struct spinand_manufacturer ato_spinand_manufacturer;
- extern const struct spinand_manufacturer esmt_8c_spinand_manufacturer;
  extern const struct spinand_manufacturer esmt_c8_spinand_manufacturer;
 +extern const struct spinand_manufacturer etron_spinand_manufacturer;
  extern const struct spinand_manufacturer fmsh_spinand_manufacturer;
-- 
2.43.0

